flowchart TB

subgraph CL[Client Layer]
  CodeUI["Code Practice UI\n- Task 보기\n - 제출(Submit)\n - Job 상태 확인\n - 결과/피드백 조회"]
end

subgraph IAM[API Gateway and Identity]
  Gateway[API Gateway]
  Rate[Rate Limiter]
  Auth["Auth (JWT, OAuth)"]
  RBAC["RBAC/Scopes\n (user/admin/author)"]
  Gateway --> Rate --> Auth --> RBAC
end

subgraph API[Practice API - Code Practice]
  CodeAPI["Code Practice API\n - get task\n - submit -> job_id\n - get status/result"]
  Idem["Idempotency Key\n (중복 제출 방지)"]
  CodeAPI --> Idem
end

subgraph CONTENT[Content Service - Versioned]
  ContentAPI["Content API\n (scenario, constraints, templates)"]
  ContentDB["(Content DB)\nversioned"]
  TestVault["(TestCase Vault)\n encrypted + access control"]
  ContentAPI --> ContentDB
  ContentAPI --> TestVault
end

subgraph JOB[Async Job System]
  Queue[Job Queue]
  Scheduler[Job Scheduler/Dispatcher]
  Queue --> Scheduler
end

subgraph WORKERS[Worker Pool]
  Runner["Runner Worker\n (pull job)"]
  ExecOrch[Execution Orchestrator]
  Runner --> ExecOrch
end

subgraph EXEC[Secure Execution Boundary]
  Sandbox["Sandbox Runtime\n - isolation\n - no egress network\n - CPU/Mem/Time limits\n - read-only FS + workspace"]
  Tests["Test Runner\n (unit, integration)"]
  Sandbox --> Tests
end

subgraph EVAL[Evaluation and Feedback]
  Objective["Objective Scoring\n (pass/fail, score, reasons)"]
  Feedback["LLM Coach Feedback\n (grounded on objective + logs)"]
  Objective --> Feedback
end

subgraph DATA[Data Stores]
  ArtifactStore["Object Storage\n (code, logs, artifacts)"]
  ResultDB["(Result DB)"]
  ProgressDB["(Progress DB)\n FSM + version field"]
  Audit["(Audit Log)"]
end

subgraph REC[Recommendation]
  Next["Next Step Service\n (rule-based + heuristics)"]
end

subgraph OBS[Observability - Required]
  Logs[Central Logging]
  Metrics[Metrics]
  Traces[Tracing]
  Alerts[Alerting]
end

CodeUI --> Gateway --> CodeAPI

CodeAPI --> ContentAPI

CodeAPI --> Queue
CodeAPI --> ProgressDB

Scheduler --> Runner

Runner -->|"fetch content and testcases"| ContentAPI
ExecOrch --> Sandbox
Sandbox --> ArtifactStore
Tests --> ArtifactStore

Tests --> Objective --> ResultDB
Feedback --> ResultDB

Objective -->|"evaluated event"| ProgressDB
ProgressDB --> Next --> CodeUI

RBAC --> Audit
CodeAPI --> Audit
Runner --> Audit

CodeAPI --> Logs
Runner --> Logs
Sandbox --> Logs

CodeAPI --> Metrics
Runner --> Metrics
Sandbox --> Metrics

CodeAPI --> Traces
Runner --> Traces
