flowchart TB
    subgraph "Client Layer"
        UI["Web/Mobile UI"]
        CodeEditor["Code Editor"]
        DiagramEditor["Diagram Editor\n(Mermaid)"]
    end

    subgraph "API Gateway & Auth"
        Gateway["API Gateway"]
        RateLimit["Rate Limiter"]
        Auth["Auth Service\n(JWT)"]
    end

    subgraph "Content Management"
        ScenarioDB[(Scenario DB)]
        ConstraintsDB[(Constraints DB)]
        TestCaseDB[(Test Cases)]
        TemplateDB[(Solution Templates)]
    end

    subgraph "Core Practice Services"
        Router["Practice Router\n(Thin Dispatcher + Step Gate)"]

        subgraph "Code Practice"
            CodeHandler["Code Submission"]
            Sandbox["Sandbox Runner"]
            CodeCheck["Code Check\n(Run Tests)"]
        end

        subgraph "Debug Practice"
            DebugHandler["Debug Submission"]
            DebugCheck["Debug Check\n(Diff/Explain)"]
        end

        subgraph "System Practice"
            SystemHandler["System Design Submission"]
            SystemCheck["System Check\n(Checklist)"]
        end

        subgraph "Ops Practice"
            OpsHandler["Incident Submission"]
            OpsCheck["Ops Check\n(Checklist)"]
        end

        subgraph "Agent Practice"
            AgentHandler["Agent Submission"]
            AgentCheck["Agent Check\n(Checklist)"]
        end
    end

    subgraph "Evaluation Engine (Unified)"
        TestManager["Test Case / Rule Manager"]
        ObjectiveFB["Objective Feedback\n(pass/fail, score, reasons)"]
    end

    subgraph "AI/LLM Layer (MVP)"
        LLMFeedback["Feedback Generator (LLM)\n- Hint/Coach\n- Best Practice Summary\n- Next Step Tip"]
    end

    subgraph "User Progress"
        ProgressTracker["Progress Tracker\n(current_step 1-5)"]
        UserHistory[(User Data & History)]
        Recommender["Next Step\n(Rule-based)"]
    end

    subgraph "Infrastructure (MVP)"
        Storage["Object Storage (optional)"]
        Cache["Cache (optional)"]
        Monitoring["Monitoring & Logging (minimal)"]
    end

    UI --> Gateway
    CodeEditor --> Gateway
    DiagramEditor --> Gateway

    Gateway --> RateLimit --> Auth --> Router

    Router --> CodeHandler
    Router --> DebugHandler
    Router --> SystemHandler
    Router --> OpsHandler
    Router --> AgentHandler

    CodeHandler --> Sandbox --> CodeCheck
    DebugHandler --> DebugCheck
    SystemHandler --> SystemCheck
    OpsHandler --> OpsCheck
    AgentHandler --> AgentCheck

    ScenarioDB --> Router
    ConstraintsDB --> Router
    TestCaseDB --> TestManager
    TemplateDB --> TestManager

    CodeCheck --> TestManager
    DebugCheck --> TestManager
    SystemCheck --> TestManager
    OpsCheck --> TestManager
    AgentCheck --> TestManager

    TestManager --> ObjectiveFB
    ObjectiveFB --> LLMFeedback

    LLMFeedback --> ProgressTracker
    ProgressTracker --> UserHistory
    UserHistory --> Recommender
    Recommender --> UI

    Monitoring -.-> Router
    Storage -.-> Router
    Cache -.-> Router
